<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmdp.lock.mapper.LockWaitQueueMapper">
    <insert id="addToQueue">
        INSERT INTO lock_wait_queue (lock_key, sequence, instance_id, create_time, expire_time)
        VALUES (#{lockKey}, #{sequence}, #{instanceId}, #{createTime}, #{expireTime})
    </insert>

    <delete id="removeFromQueue">
        DELETE FROM lock_wait_queue
        WHERE lock_key = #{lockKey} AND sequence = #{sequence}
    </delete>

    <select id="selectMinSequence" resultType="java.lang.Long">
        SELECT MIN(sequence) FROM lock_wait_queue
        WHERE lock_key = #{lockKey} AND expire_time &gt; NOW()
    </select>

    <delete id="cleanExpired">
        DELETE FROM lock_wait_queue
        WHERE lock_key = #{lockKey} AND expire_time &lt;= #{now}
    </delete>

    <select id="exists" resultType="java.lang.Boolean">
        SELECT COUNT(1) &gt; 0 FROM lock_wait_queue
        WHERE lock_key = #{lockKey} AND sequence = #{sequence} AND instance_id = #{instanceId}
    </select>
</mapper>